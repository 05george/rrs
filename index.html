<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100svh;
  overflow-x: auto;
  overflow-y: hidden;
  background: black;
}
body { display: block; width: auto; height: 100svh; }
#main-svg {
  height: 100svh;
  display: block;
  background: black;
}
.image-mapper-shape {  
  fill: transparent;  
  stroke: yellow;   
  stroke-width: 2px;  
  transform-origin: center center;  
  transition: transform 0.3s ease, filter 0.3s ease;
}
.q { stroke: red; }
.v { stroke: blue; }
.ipc { stroke: white; }
.o { stroke: #80CBC4; }
.a { stroke: #F48FB1; }
.zoom-part {
  pointer-events: none;
  transition: transform 0.3s ease, filter 0.3s ease, opacity 0.3s ease;
  image-rendering: auto;
}
</style>
</head>
<body>

<svg id="main-svg" xmlns="http://www.w3.org/2000/svg">
  <defs id="clip-defs"></defs>
</svg>

<script>
// ====== البيانات الديناميكية للصور والمجموعات ======
const imageGroups = [
  { src: 'image/1.png', links: [
      { href: 'micro/1.pdf', x: 368, y: 703, w: 115, h: 380, cls: 'image-mapper-shape' },
      { href: 'patho/1.pdf', x: 368, y: 1083, w: 115, h: 253.5, cls: 'image-mapper-shape' },
      { href: 'patho/q/1.pdf', x: 368, y: 1339, w: 115, h: 125, cls: 'image-mapper-shape q' }
    ]
  },
  { src: 'image/2.png', links: [
      { href: '#', x: 137.73, y: 348.2, w: 115.4, h: 383.8, cls: 'image-mapper-shape' },
      { href: 'ipc/book.pdf', x: 137.52, y: 875.78, w: 114.89, h: 348.72, cls: 'image-mapper-shape ipc' }
    ]
  },
  { src: 'image/3.png', links: [] },
  { src: 'image/4.png', links: [] }
];

// ====== إنشاء المجموعات تلقائيًا ======
const mainSvg = document.getElementById('main-svg');
const clipDefs = document.getElementById('clip-defs');

let offsetX = 0;
imageGroups.forEach((grp, grpIndex) => {
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('transform', `translate(${offsetX},0)`);
  g.setAttribute('id', `group-${grpIndex+1}`);
  
  // إضافة الصورة الأساسية
  const img = document.createElementNS('http://www.w3.org/2000/svg','image');
  img.setAttribute('href', grp.src);
  img.setAttribute('x', 0);
  img.setAttribute('y', 0);
  img.setAttribute('width', 1024);
  img.setAttribute('height', 2454);
  img.setAttribute('preserveAspectRatio', 'xMinYMin meet');
  g.appendChild(img);

  // إضافة الروابط
  grp.links.forEach((lnk, i) => {
    const a = document.createElementNS('http://www.w3.org/2000/svg','a');
    a.setAttribute('xlink:href', lnk.href);
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', lnk.x);
    rect.setAttribute('y', lnk.y);
    rect.setAttribute('width', lnk.w);
    rect.setAttribute('height', lnk.h);
    rect.setAttribute('class', lnk.cls);
    a.appendChild(rect);
    g.appendChild(a);
  });

  mainSvg.appendChild(g);
  offsetX += 1024; // زيادة الإزاحة أفقياً لكل مجموعة
});

// ====== وظائف hover, zoom, glow كما في الكود السابق ======
const activeState = { rect: null, zoomPart: null, animationId: null, clipPathId: null };
const groups = document.querySelectorAll('g');

function getTransformX(groupElement) {
  const transformAttr = groupElement.getAttribute('transform');
  if (!transformAttr) return 0;
  const match = transformAttr.match(/translate\(([\d\.-]+),\s*([\d\.-]+)\)/);
  return match ? parseFloat(match[1]) : 0;
}
function getTransformY(groupElement) {
  const transformAttr = groupElement.getAttribute('transform');
  if (!transformAttr) return 0;
  const match = transformAttr.match(/translate\(([\d\.-]+),\s*([\d\.-]+)\)/);
  return match ? parseFloat(match[2]) : 0;
}
function getGroupImage(parentGroup) {
  const baseImage = parentGroup.querySelector('image');
  if (!baseImage) return null;
  const IMAGE_SRC = baseImage.getAttribute('href') || baseImage.getAttribute('xlink:href');
  return { src: IMAGE_SRC, width: parseFloat(baseImage.getAttribute('width')), height: parseFloat(baseImage.getAttribute('height')) };
}
function cleanupHover() {
  if (!activeState.rect) return;
  if(activeState.animationId) clearInterval(activeState.animationId);
  activeState.rect.style.transform = 'scale(1)';
  activeState.rect.style.filter = 'none';
  if(activeState.zoomPart){ activeState.zoomPart.remove(); }
  const currentClip = document.getElementById(activeState.clipPathId);
  if(currentClip) currentClip.remove();
  activeState.rect = null;
  activeState.zoomPart = null;
  activeState.animationId = null;
  activeState.clipPathId = null;
}

function attachHover(rect, i) {
  const anchor = rect.closest('a');
  const clipPathId = `clip-${i}-${Date.now()}`;
  const scale = 1.1;
  const parentGroup = rect.closest('g');
  const imageData = getGroupImage(parentGroup);
  if (!imageData) return;
  const groupOffsetX = getTransformX(parentGroup);
  const groupOffsetY = getTransformY(parentGroup);

  rect.setAttribute('data-index', i);
  rect.addEventListener('mouseover', startHover);
  rect.addEventListener('mouseout', stopHover);
  rect.addEventListener('touchstart', startHover);
  rect.addEventListener('touchend', cleanupHover);

  function startHover() {
    if(activeState.rect === rect) return;
    cleanupHover();
    activeState.rect = rect;
    activeState.clipPathId = clipPathId;

    const x = parseFloat(rect.getAttribute('x'));
    const y = parseFloat(rect.getAttribute('y'));
    const width = parseFloat(rect.getAttribute('width'));
    const height = parseFloat(rect.getAttribute('height'));
    const absoluteX = x + groupOffsetX;
    const absoluteY = y + groupOffsetY;

    let clip = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
    clip.setAttribute('id', clipPathId);
    let clipRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    clipRect.setAttribute('x', absoluteX);
    clipRect.setAttribute('y', absoluteY);
    clipRect.setAttribute('width', width);
    clipRect.setAttribute('height', height);
    clipDefs.appendChild(clip).appendChild(clipRect);

    const zoomPart = document.createElementNS('http://www.w3.org/2000/svg','image');
    zoomPart.setAttribute('href', imageData.src);
    zoomPart.setAttribute('width', imageData.width);
    zoomPart.setAttribute('height', imageData.height);
    zoomPart.setAttribute('class','zoom-part');
    zoomPart.setAttribute('clip-path', `url(#${clipPathId})`);
    zoomPart.setAttribute('x', groupOffsetX);
    zoomPart.setAttribute('y', groupOffsetY);
    zoomPart.style.transformOrigin = `${absoluteX + width/2}px ${absoluteY + height/2}px`;
    zoomPart.style.opacity = 0;
    mainSvg.appendChild(zoomPart);
    activeState.zoomPart = zoomPart;

    rect.style.transformOrigin = `${x + width/2}px ${y + height/2}px`;
    rect.style.transform = `scale(${scale})`;
    zoomPart.style.transform = `scale(${scale})`;
    zoomPart.style.opacity = 1;

    let hue = 0;
    const animationId = setInterval(() => {
      hue = (hue + 1) % 360;
      const glow = `drop-shadow(0 0 8px hsl(${hue},100%,55%)) drop-shadow(0 0 14px hsl(${(hue+60)%360},100%,60%))`;
      rect.style.filter = glow;
      if(zoomPart) zoomPart.style.filter = glow;
    }, 100);
    activeState.animationId = animationId;
  }

  function stopHover(e) {
    const targetRect = e ? (e.target.tagName==='rect'? e.target: e.target.closest('a')?.querySelector('.image-mapper-shape')) : rect;
    if(targetRect===activeState.rect && e.type==='mouseout'){ cleanupHover(); }
  }
}

// تفعيل hover لجميع الروابط الموجودة حاليا أو مستقبلا
groups.forEach(group => {
  group.querySelectorAll('.image-mapper-shape').forEach((rect,i)=>{ attachHover(rect,i); });
});

const rootObserver = new MutationObserver(()=>{
  document.querySelectorAll('rect.image-mapper-shape:not([data-processed])').forEach((rect,i)=>{
    attachHover(rect,i);
    rect.setAttribute('data-processed','true');
  });
});
rootObserver.observe(mainSvg,{ childList:true, subtree:true });

// ضبط فتح الروابط حسب الجهاز
function setLinkTarget() {
  const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints>0) || (window.innerWidth<800);
  const allLinks = document.querySelectorAll('a[xlink\\:href], a[href]');
  allLinks.forEach(link=>{
    if(isMobile){ link.removeAttribute('target'); }
    else { link.setAttribute('target','_blank'); }
  });
}
setLinkTarget();
</script>
</body>
</html>